services:
  # 1. Auth Service
  - type: web
    name: auth-service
    env: docker
    dockerContext: ./auth-service
    dockerfilePath: ./auth-service/Dockerfile
    plan: free
    region: oregon
    numInstances: 1
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: cancer-db
          property: connectionString
      - key: SECRET_KEY
        generateValue: true
      - key: PORT
        value: 8000

  # 2. Data Service
  - type: web
    name: data-service
    env: docker
    dockerContext: ./data-service
    dockerfilePath: ./data-service/Dockerfile
    plan: free
    region: oregon
    numInstances: 1
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: cancer-db
          property: connectionString
      - key: PORT
        value: 8002

  # 3. Inference Service
  - type: web
    name: inference-service
    env: docker
    dockerContext: ./inference-service
    dockerfilePath: ./inference-service/Dockerfile
    plan: free
    region: oregon
    numInstances: 1
    # NOTE: This service requires model.h5 to be present in the build context or downloaded at runtime.
    envVars:
      - key: DATA_SERVICE_URL
        fromService:
          type: web
          name: data-service
          envVar: SERVICE_URL # Or use internal URL directly if supported
          property: hostport
      - key: PORT
        value: 8001

  # 4. API Gateway
  - type: web
    name: api-gateway
    env: docker
    dockerContext: ./api-gateway
    dockerfilePath: ./api-gateway/Dockerfile
    plan: free
    region: oregon
    numInstances: 1
    envVars:
      - key: AUTH_SERVICE_URL
        fromService:
          type: web
          name: auth-service
          property: hostport
      - key: DATA_SERVICE_URL
        fromService:
          type: web
          name: data-service
          property: hostport
      - key: INFERENCE_SERVICE_URL
        fromService:
          type: web
          name: inference-service
          property: hostport
      - key: PORT
        value: 8000

  # 5. Frontend
  - type: web
    name: frontend
    env: docker
    dockerContext: ./frontend
    dockerfilePath: ./frontend/Dockerfile
    plan: free
    region: oregon
    numInstances: 1
    envVars:
      - key: API_GATEWAY_URL
        fromService:
          type: web
          name: api-gateway
          property: hostport
      - key: PORT
        value: 8501

databases:
  - name: cancer-db
    plan: free
    region: oregon
